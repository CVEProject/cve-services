const server = require('../../../test-utils/index')
const chai = require('chai')
const expect = chai.expect
chai.use(require('chai-http'))

const secretariatHeader = require('./mockObjects.org').secretariatHeader
const owningOrgHeader = require('./mockObjects.org').owningOrgHeader
const orgHeader = require('./mockObjects.org').orgHeader
const existentUser = require('./mockObjects.org').existentUser
const nonExistentUser = require('./mockObjects.org').nonExistentUser
const existentOrg = require('./mockObjects.org').existentOrg
const owningOrg = require('./mockObjects.org').owningOrg
const existentUserDummy = require('./mockObjects.org').existentUserDummy
const nonExistentOrg = require('./mockObjects.org').nonExistentOrg

const errors = require('../../../src/controller/org.controller/error')
const error = new errors.OrgControllerError()

describe('Test user functions in Org Controller', () => {
  context('Creating a user', () => {
    it('User is not created because org does not exist', (done) => {
      // perform the request to the api
      chai.request(server)
        .post(`/user-not-created-org-does-not-exist/${nonExistentOrg.short_name}`)
        .set(secretariatHeader)
        .send(nonExistentUser)
        .end((err, res) => {
          if (err) {
            done(err)
          }

          // assert expected response
          expect(res).to.have.status(404)
          expect(res).to.have.property('body').and.to.be.a('object')
          const errObj = error.orgDneParam(nonExistentOrg.short_name)
          expect(res.body.error).to.equal(errObj.error)
          expect(res.body.message).to.equal(errObj.message)
          done()
        })
    })

    it('Param org\'s UUID does not match the provided org\'s UUID', (done) => {
      const testUser = Object.assign({}, existentUser)
      testUser.org_UUID = owningOrg.UUID

      // perform the request to the api
      chai.request(server)
        .post(`/user-not-created-org-does-not-match/${existentOrg.short_name}`)
        .set(secretariatHeader)
        .send(testUser)
        .end((err, res) => {
          if (err) {
            done(err)
          }

          // assert expected response
          expect(res).to.have.status(400)
          expect(res).to.have.property('body').and.to.be.a('object')
          const errObj = error.shortnameMismatch(existentOrg.short_name, owningOrg.short_name)
          expect(res.body.error).to.equal(errObj.error)
          expect(res.body.message).to.equal(errObj.message)
          done()
        })
    })

    it('User is created when org UUID is undefined', (done) => {
      const testUser = Object.assign({}, nonExistentUser)
      delete testUser.org_UUID

      // perform the request to the api
      chai.request(server)
        .post(`/user-created-org-undefined/${existentOrg.short_name}`)
        .set(secretariatHeader)
        .send(testUser)
        .end((err, res) => {
          if (err) {
            done(err)
          }

          // assert expected response
          expect(res).to.have.status(200)
          expect(res).to.have.property('body').and.to.be.a('object')
          expect(res.body).to.have.property('message').and.to.be.a('string')
          expect(res.body.message).to.equal(testUser.username + ' was successfully created.')
          expect(res.body).to.have.property('created').and.to.be.a('object')
          expect(res.body.created).to.have.property('org_UUID').and.to.equal(existentOrg.UUID)
          expect(res.body.created).to.have.property('username').and.to.equal(testUser.username)
          done()
        })
    })

    it('User is created when org UUID is null', (done) => {
      const testUser = Object.assign({}, nonExistentUser)
      testUser.org_UUID = null

      // perform the request to the api
      chai.request(server)
        .post(`/user-created-org-null/${existentOrg.short_name}`)
        .set(secretariatHeader)
        .send(testUser)
        .end((err, res) => {
          if (err) {
            done(err)
          }
          // assert expected response
          expect(res).to.have.status(200)
          expect(res).to.have.property('body').and.to.be.a('object')
          expect(res.body).to.have.property('message').and.to.be.a('string')
          expect(res.body.message).to.equal(testUser.username + ' was successfully created.')
          expect(res.body).to.have.property('created').and.to.be.a('object')
          expect(res.body.created).to.have.property('org_UUID').and.to.equal(existentOrg.UUID)
          expect(res.body.created).to.have.property('username').and.to.equal(testUser.username)
          done()
        })
    })

    it('User is created when user UUID is undefined', (done) => {
      const testUser = Object.assign({}, nonExistentUser)
      delete testUser.UUID
      // perform the request to the api
      chai.request(server)
        .post(`/user-created-uuid-undefined/${existentOrg.short_name}`)
        .set(secretariatHeader)
        .send(testUser)
        .end((err, res) => {
          if (err) {
            done(err)
          }
          // assert expected response
          expect(res).to.have.status(200)
          expect(res).to.have.property('body').and.to.be.a('object')
          expect(res.body).to.have.property('message').and.to.be.a('string')
          expect(res.body.message).to.equal(testUser.username + ' was successfully created.')
          expect(res.body).to.have.property('created').and.to.be.a('object')
          expect(res.body.created).to.have.property('org_UUID').and.to.equal(testUser.org_UUID)
          expect(res.body.created).to.have.property('username').and.to.equal(testUser.username)
          expect(res.body.created).to.have.property('UUID').and.to.be.a('string')
          done()
        })
    })

    it('User is created when UUID is null', (done) => {
      const testUser = Object.assign({}, nonExistentUser)
      testUser.UUID = null
      // perform the request to the api
      chai.request(server)
        .post(`/user-created-uuid-null/${existentOrg.short_name}`)
        .set(secretariatHeader)
        .send(testUser)
        .end((err, res) => {
          if (err) {
            done(err)
          }
          // assert expected response
          expect(res).to.have.status(200)
          expect(res).to.have.property('body').and.to.be.a('object')
          expect(res.body).to.have.property('message').and.to.be.a('string')
          expect(res.body.message).to.equal(testUser.username + ' was successfully created.')
          expect(res.body).to.have.property('created').and.to.be.a('object')
          expect(res.body.created).to.have.property('org_UUID').and.to.equal(testUser.org_UUID)
          expect(res.body.created).to.have.property('username').and.to.equal(testUser.username)
          expect(res.body.created).to.have.property('UUID').and.to.be.a('string')
          done()
        })
    })

    it('User is created when UUID is defined', (done) => {
      // perform the request to the api
      chai.request(server)
        .post(`/user-created-uuid-defined/${existentOrg.short_name}`)
        .set(secretariatHeader)
        .send(nonExistentUser)
        .end((err, res) => {
          if (err) {
            done(err)
          }
          // assert expected response
          expect(res).to.have.status(200)
          expect(res).to.have.property('body').and.to.be.a('object')
          expect(res.body).to.have.property('message').and.to.be.a('string')
          expect(res.body.message).to.equal(nonExistentUser.username + ' was successfully created.')
          expect(res.body).to.have.property('created').and.to.be.a('object')
          expect(res.body.created).to.have.property('org_UUID').and.to.equal(nonExistentUser.org_UUID)
          expect(res.body.created).to.have.property('username').and.to.equal(nonExistentUser.username)
          expect(res.body.created).to.have.property('UUID').and.to.equal(nonExistentUser.UUID)
          done()
        })
    })

    it('User is not created because it already exists', (done) => {
      // perform the request to the api
      chai.request(server)
        .post(`/user-not-created-already-exists/${existentOrg.short_name}`)
        .set(secretariatHeader)
        .send(existentUser)
        .end((err, res) => {
          if (err) {
            done(err)
          }
          // assert expected response
          expect(res).to.have.status(400)
          expect(res).to.have.property('body').and.to.be.a('object')
          const errObj = error.userExists(existentUser.username)
          expect(res.body.error).to.equal(errObj.error)
          expect(res.body.message).to.equal(errObj.message)
          done()
        })
    })
  })

  context('Updating a user', () => {
    it('User is not updated because org does not exist', (done) => {
      // perform the request to the api
      const shortname = nonExistentOrg.short_name.replace(/\s/g, '')
      const username = existentUser.username.replace(/\s/g, '')
      chai.request(server)
        .post(`/user-not-updated-org-doesnt-exist/${shortname}/${username}`)
        .set(secretariatHeader)
        .end((err, res) => {
          if (err) {
            done(err)
          }
          // assert expected response
          expect(res).to.have.status(404)
          expect(res).to.have.property('body').and.to.be.a('object')
          const errObj = error.orgDneParam(nonExistentOrg.short_name)
          expect(res.body.error).to.equal(errObj.error)
          expect(res.body.message).to.equal(errObj.message)
          done()
        })
    })

    it('User is not updated because user does not exist', (done) => {
      // perform the request to the api
      const shortname = existentOrg.short_name.replace(/\s/g, '')
      const username = nonExistentUser.username.replace(/\s/g, '')
      chai.request(server)
        .post(`/user-not-updated-doesnt-exist/${shortname}/${username}`)
        .set(secretariatHeader)
        .end((err, res) => {
          if (err) {
            done(err)
          }

          // assert expected response
          expect(res).to.have.status(404)
          expect(res).to.have.property('body').and.to.be.a('object')
          const errObj = error.userDne(nonExistentUser.username)
          expect(res.body.error).to.equal(errObj.error)
          expect(res.body.message).to.equal(errObj.message)
          done()
        })
    })

    it('User is not updated because the new shortname does not exist', (done) => {
      // perform the request to the api
      chai.request(server)
        .post(`/user-not-updated-user-doesnt-exist/${existentOrg.short_name}/${existentUser.username}?new_cna_shortname=${nonExistentOrg.short_name}`)
        .set(secretariatHeader)
        .end((err, res) => {
          if (err) {
            done(err)
          }
          // assert expected response
          expect(res).to.have.status(404)
          expect(res).to.have.property('body').and.to.be.a('object')
          const errObj = error.orgDne(nonExistentOrg.short_name)
          expect(res.body.error).to.equal(errObj.error)
          expect(res.body.message).to.equal(errObj.message)
          done()
        })
    })

    // check that the user is unchanged
    it('No query parameters are provided', async () => {
      const result = existentUser
      // perform the request to the api
      const res = await chai.request(server)
        .post(`/user-not-updated-no-parameters/${existentOrg.short_name}/${existentUser.username}`)
        .set(secretariatHeader)
      // assert expected response
      expect(res).to.have.status(200)
      expect(res).to.have.property('body').and.to.be.a('object')
      expect(res.body).to.have.property('updated').and.to.be.a('object')
      expect(JSON.stringify(res.body.updated)).to.equal('{}')
      expect(result.cna_short_name).to.equal(existentUser.cna_short_name)
      expect(result.username).to.equal(existentUser.username)
      expect(result.UUID).to.equal(existentUser.UUID)
      expect(result.secret).to.equal(existentUser.secret)
      expect(result.active).to.equal(existentUser.active)
      expect(result.name.first).to.equal(existentUser.name.first)
      expect(result.name.last).to.equal(existentUser.name.last)
      expect(result.name.middle).to.equal(existentUser.name.middle)
      expect(result.name.suffix).to.equal(existentUser.name.suffix)
      expect(result.name.surname).to.equal(existentUser.name.surname)
    })
  })

  context('Resetting a user\'s secret', () => {
    it('User secret is not reset because org does not exists', (done) => {
      // perform the request to the api
      chai.request(server)
        .post(`/user-secret-not-reset-org-doesnt-exist/${nonExistentOrg.short_name}/${existentUser.username}`)
        .set(secretariatHeader)
        .end((err, res) => {
          if (err) {
            done(err)
          }

          // assert expected response
          expect(res).to.have.status(404)
          expect(res).to.have.property('body').and.to.be.a('object')
          const errObj = error.orgDneParam(nonExistentOrg.short_name)
          expect(res.body.error).to.equal(errObj.error)
          expect(res.body.message).to.equal(errObj.message)
          done()
        })
    })

    it('User secret is not reset because user does not exists', (done) => {
      // perform the request to the api
      chai.request(server)
        .post(`/user-secret-not-reset-user-doesnt-exist/${existentOrg.short_name}/${nonExistentUser.username}`)
        .set(secretariatHeader)
        .end((err, res) => {
          if (err) {
            done(err)
          }

          // assert expected response
          expect(res).to.have.status(404)
          expect(res).to.have.property('body').and.to.be.a('object')
          const errObj = error.userDne(nonExistentUser.username)
          expect(res.body.error).to.equal(errObj.error)
          expect(res.body.message).to.equal(errObj.message)
          done()
        })
    })

    it('User secret is reset', (done) => {
      chai.request(server)
        // perform the request to the api
        .post(`/user-secret-reset/${existentOrg.short_name}/${existentUser.username}`)
        .set(secretariatHeader)
        .end((err, res) => {
          if (err) {
            done(err)
          }
          // assert expected response
          expect(res).to.have.status(200)
          expect(res).to.have.property('body').and.to.be.a('object')
          expect(res.body).to.have.property('API-secret').and.to.be.a('string')
          done()
        })
    })
  })

  context('Getting a user', () => {
    it('Org does not exists', (done) => {
      // perform the request to the api
      chai.request(server)
        .get(`/user-get-user-org-doesnt-exist/${nonExistentOrg.short_name}/${existentUser.username}`)
        .set(secretariatHeader)
        .end((err, res) => {
          if (err) {
            done(err)
          }

          // assert expected response
          expect(res).to.have.status(404)
          expect(res).to.have.property('body').and.to.be.a('object')
          const errObj = error.orgDneParam(nonExistentOrg.short_name)
          expect(res.body.error).to.equal(errObj.error)
          expect(res.body.message).to.equal(errObj.message)
          done()
        })
    })

    it('User does not exists', (done) => {
      // perform the request to the api
      chai.request(server)
        .get(`/user-get-user-user-doesnt-exist/${existentOrg.short_name}/${nonExistentUser.username}`)
        .set(secretariatHeader)
        .end((err, res) => {
          if (err) {
            done(err)
          }

          // assert expected response
          expect(res).to.have.status(404)
          expect(res).to.have.property('body').and.to.be.a('object')
          const errObj = error.userDne(nonExistentUser.username)
          expect(res.body.error).to.equal(errObj.error)
          expect(res.body.message).to.equal(errObj.message)
          done()
        })
    })

    it('User exists and the requester is the secretariat', (done) => {
      // perform the request to the api
      chai.request(server)
        .get(`/user-get-user/${existentOrg.short_name}/${existentUser.username}`)
        .set(secretariatHeader)
        .end((err, res) => {
          if (err) {
            done(err)
          }
          // assert expected response
          expect(res).to.have.status(200)
          expect(res).to.have.property('body').and.to.be.a('object')
          expect(res.body).to.have.property('username').and.to.equal(existentUser.username)
          expect(res.body).to.have.property('org_UUID').and.to.equal(existentUser.org_UUID)
          done()
        })
    })

    it('User exists and the requester belongs to the user\'s org', (done) => {
      // perform the request to the api
      chai.request(server)
        .get(`/user-get-user/${owningOrg.short_name}/${existentUserDummy.username}`)
        .set(owningOrgHeader)
        .end((err, res) => {
          if (err) {
            done(err)
          }

          // assert expected response
          expect(res).to.have.status(200)
          expect(res).to.have.property('body').and.to.be.a('object')
          expect(res.body).to.have.property('username').and.to.equal(existentUserDummy.username)
          expect(res.body).to.have.property('org_UUID').and.to.equal(existentUserDummy.org_UUID)
          done()
        })
    })

    it('User exists and the requester is not secretariat and does not belong to the user\'s org', (done) => {
      // perform the request to the api
      chai.request(server)
        .get(`/user-get-user/${owningOrg.short_name}/${existentUserDummy.username}`)
        .set(orgHeader)
        .end((err, res) => {
          if (err) {
            done(err)
          }
          // assert expected response
          expect(res).to.have.status(403)
          expect(res).to.have.property('body').and.to.be.a('object')
          const errObj = error.notSameOrgOrSecretariat()
          expect(res.body.error).to.equal(errObj.error)
          expect(res.body.message).to.equal(errObj.message)
          done()
        })
    })
  })
})
