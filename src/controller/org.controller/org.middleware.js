const logger = require('../../middleware/logger')
const CONSTANTS = require('../../constants')
const { validationResult } = require('express-validator')
const errors = require('./error')
const error = new errors.OrgControllerError()
const utils = require('../../utils/utils')

function isOrgRole (val) {
  val.forEach(role => {
    if (!CONSTANTS.ORG_ROLES.includes(role)) {
      logger.info('Invalid role for organization', role)
      throw new Error('The organization role \'' + role + '\' does not exist.')
    }
  })

  return true
}

function parsePostParams (req, res, next) {
  utils.reqCtxMapping(req, 'body', [])
  utils.reqCtxMapping(req, 'query', [
    'shortname', 'name', 'id_quota', 'active',
    'active_roles.add', 'active_roles.remove',
    'new_username', 'new_cna_shortname',
    'name.first', 'name.last', 'name.middle', 'name.suffix', 'name.surname'
  ])
  utils.reqCtxMapping(req, 'params', ['shortname', 'username'])
  next()
}

function parseGetParams (req, res, next) {
  utils.reqCtxMapping(req, 'params', ['shortname', 'username'])
  next()
}

function parseError (req, res, next) {
  const err = validationResult(req)
  if (!err.isEmpty()) {
    return res.status(400).json(error.badInput(err.array()))
  }
  next()
}

module.exports = {
  parsePostParams,
  parseGetParams,
  parseError,
  isOrgRole
}
