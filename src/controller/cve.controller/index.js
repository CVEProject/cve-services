const express = require('express')
const router = express.Router()
const mw = require('../../middleware/middleware')
const controller = require('./cve.controller')
const { body, param, query } = require('express-validator')
const { parseGetParams, parsePostParams, parseError, toDate, validateCveCnaContainerJsonSchema, validateRejectBody, onlyOneEnglishDescription } = require('./cve.middleware')
const CONSTANTS = require('../../constants')
const CHOICES = [CONSTANTS.CVE_STATES.REJECTED, CONSTANTS.CVE_STATES.PUBLISHED]

router.get('/cve/:id',
  param(['id']).isString().matches(/^CVE-[0-9]{4}-[0-9]{4,}$/i),
  parseError,
  parseGetParams,
  controller.CVE_GET_SINGLE)

router.get('/cve',
  query(['page']).optional().isInt({ min: CONSTANTS.PAGINATOR_PAGE }),
  query(['time_modified.lt']).optional().isString().trim().escape().customSanitizer(val => { return toDate(val) }).not().isEmpty(),
  query(['time_modified.gt']).optional().isString().trim().escape().customSanitizer(val => { return toDate(val) }).not().isEmpty(),
  query(['state']).optional().isString().trim().escape().customSanitizer(val => { return val.toUpperCase() }).isIn(CHOICES),
  query(['count_only']).optional().isBoolean(),
  query(['assignerShortName']).optional().isString().trim().escape().notEmpty().isLength({ min: 2, max: 32 }),
  query(['assigner']).optional().isString().trim().escape().notEmpty(),
  parseError,
  parseGetParams,
  controller.CVE_GET_FILTERED)

/**
 * This endpoint has become an internal admin endpoint restricted to Secretariat.
 *
 * The intention is to allow an endpoint where the Secretariat can do a full replacement
 * of the record in severe cases where data integrity is of concern.
 */
router.post('/cve/:id',
  mw.onlySecretariat,
  mw.validateUser,
  mw.validateCveJsonSchema,
  param(['id']).isString().matches(/^CVE-[0-9]{4}-[0-9]{4,}$/i),
  parseError,
  parsePostParams,
  controller.CVE_SUBMIT)

/**
 * This endpoint has become an internal admin endpoint restricted to Secretariat.
 *
 * The intention is to allow an endpoint where the Secretariat can do a full replacement
 * of the record in severe cases where data integrity is of concern.
 */
router.put('/cve/:id',
  mw.onlySecretariat,
  mw.validateUser,
  mw.validateCveJsonSchema,
  param(['id']).isString().matches(/^CVE-[0-9]{4}-[0-9]{4,}$/i),
  parseError,
  parsePostParams,
  controller.CVE_UPDATE_SINGLE)

router.post('/cve/:id/cna',
  mw.onlyCnas,
  mw.validateUser,
  validateCveCnaContainerJsonSchema,
  param(['id']).isString().matches(/^CVE-[0-9]{4}-[0-9]{4,}$/i),
  parseError,
  parsePostParams,
  mw.cnaMustOwnID,
  controller.CVE_SUBMIT_CNA)

router.put('/cve/:id/cna',
  mw.onlyCnas,
  mw.validateUser,
  validateCveCnaContainerJsonSchema,
  param(['id']).isString().matches(/^CVE-[0-9]{4}-[0-9]{4,}$/i),
  parseError,
  parsePostParams,
  mw.cnaMustOwnID,
  controller.CVE_UPDATE_CNA)

router.post('/cve/:id/reject',
  mw.onlyCnas,
  mw.validateUser,
  validateRejectBody,
  param(['id']).isString().matches(/^CVE-[0-9]{4}-[0-9]{4,}$/i),
  body(['cnaContainer.rejectedReasons']).isArray().custom((arr) => {
    if (onlyOneEnglishDescription(arr) !== 1) {
      throw new Error(400, 'Bad request, more than one English description found')
    }
    return true
  }),
  body(['cnaContainer.replacedBy']).optional().isArray(),
  parseError,
  parsePostParams,
  mw.cnaMustOwnID,
  controller.CVE_REJECT_RECORD)

router.put('/cve/:id/reject',
  mw.onlyCnas,
  mw.validateUser,
  validateRejectBody,
  param(['id']).isString().matches(/^CVE-[0-9]{4}-[0-9]{4,}$/i),
  body(['cnaContainer.rejectedReasons']).isArray().custom((arr) => {
    if (onlyOneEnglishDescription(arr) !== 1) {
      throw new Error(400, 'Bad request, more than one English description found')
    }
    return true
  }),
  body(['cnaContainer.replacedBy']).optional().isArray(),
  parseError,
  parsePostParams,
  mw.cnaMustOwnID,
  controller.CVE_REJECT_EXISTING_CVE)

module.exports = router
